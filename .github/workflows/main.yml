name: CI 

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: campusevents
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -proot"
          --health-interval=5s
          --health-timeout=10s
          --health-retries=10

    env:
      DB_HOST: 127.0.0.1
      DB_USER: ciuser
      DB_PASSWORD: root
      DB_NAME: campusevents
      DB_PORT: 3306
      NODE_ENV: test
      VITE_CLERK_PUBLISHABLE_KEY: pk_test_dummy
      CLERK_PUBLISHABLE_KEY: pk_test_dummy
      CLERK_SECRET_KEY: sk_test_dummy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            if mysqladmin ping -h127.0.0.1 -uroot -proot --silent; then
              echo "MySQL is ready!"
              break
            fi
            sleep 3
          done

      - name: Install MySQL client
        run: sudo apt-get update && sudo apt-get install -y mysql-client

      - name: Create CI MySQL user
        run: |
          mysql -h127.0.0.1 -uroot -proot -e "
            CREATE USER IF NOT EXISTS 'ciuser'@'%' IDENTIFIED WITH mysql_native_password BY 'root';
            GRANT ALL PRIVILEGES ON *.* TO 'ciuser'@'%' WITH GRANT OPTION;
            FLUSH PRIVILEGES;"

      - name: Initialize MySQL schema
        run: |
          mysql -h127.0.0.1 -uciuser -proot campusevents <<'EOF'
          CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            email VARCHAR(150) NOT NULL,
            password_hash VARCHAR(255) DEFAULT 'clerk_managed_account',
            role ENUM('student','organizer','admin') NOT NULL DEFAULT 'student',
            created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
            clerk_id VARCHAR(255) DEFAULT NULL
          );

          CREATE TABLE IF NOT EXISTS events (
            id INT AUTO_INCREMENT PRIMARY KEY,
            organizer_id INT NOT NULL,
            title VARCHAR(255) NOT NULL,
            description TEXT,
            category VARCHAR(30),
            imageUrl VARCHAR(200),
            event_date DATETIME NOT NULL,
            location VARCHAR(255),
            ticket_capacity INT DEFAULT 0,
            remaining_tickets INT DEFAULT 0,
            ticket_type ENUM('free', 'paid') DEFAULT 'free',
            created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
            status ENUM('DELETED','PUBLISHED') NOT NULL DEFAULT 'PUBLISHED'
          );

          CREATE TABLE IF NOT EXISTS tickets (
            id INT AUTO_INCREMENT PRIMARY KEY,
            event_id INT NOT NULL,
            user_id INT NOT NULL,
            status ENUM('claimed', 'waitlisted') NOT NULL DEFAULT 'claimed',
            checked_in BOOLEAN NOT NULL DEFAULT 0,
            created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
            qr_code TEXT DEFAULT NULL,
            qr_payload VARCHAR(255) DEFAULT NULL
          );

          CREATE TABLE IF NOT EXISTS userSavedEvents (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            event_id INT DEFAULT NULL
          );

          CREATE TABLE IF NOT EXISTS notification (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            event_id INT NOT NULL,
            timestamp TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
          );

          CREATE TABLE IF NOT EXISTS organizer_subscriptions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            organizer_id INT NOT NULL,
            user_id INT NOT NULL,
            created_at TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
          
            UNIQUE KEY uniq_organizer_user (organizer_id, user_id),
          
            CONSTRAINT fk_os_organizer
              FOREIGN KEY (organizer_id) REFERENCES users(id)
              ON DELETE CASCADE,
            CONSTRAINT fk_os_user
              FOREIGN KEY (user_id) REFERENCES users(id)
              ON DELETE CASCADE
          );

          INSERT INTO users (id, name, email, role, clerk_id)
          VALUES
            (881, 'Test Student', 'student@example.com', 'student', 'test-user'),  -- matches getAuth().userId
            (882, 'Organizer One', 'org1@example.com', 'organizer', NULL),
            (883, 'Organizer Two', 'org2@example.com', 'organizer', NULL),
            (884, 'Another Student', 'student2@example.com', 'student', NULL);
          
          INSERT INTO events (organizer_id, title, description, category, imageUrl, event_date, location, ticket_capacity, remaining_tickets, ticket_type)
          VALUES
            (882, 'Campus Concert', 'Live music night', 'Music', 'https://example.com/img1.jpg', NOW(), 'Main Hall', 100, 50, 'free'),
            (882, 'Tech Talk', 'JS & Node deep dive', 'Tech', 'https://example.com/img2.jpg', DATE_ADD(NOW(), INTERVAL 1 DAY), 'Auditorium', 80, 80, 'free'),
            (883, 'Art Expo', 'Student art exhibition', 'Art', 'https://example.com/img3.jpg', DATE_ADD(NOW(), INTERVAL 2 DAY), 'Gallery', 120, 120, 'paid');
            
          INSERT INTO organizer_subscriptions (user_id, organizer_id)
          VALUES
            (881, 882);

          INSERT INTO users (name, email, role)
          VALUES ('Test User', 'testuser@example.com', 'student');

          INSERT INTO events (organizer_id, title, description, category, imageUrl, event_date, location, ticket_capacity, remaining_tickets, ticket_type)
          VALUES (1, 'Campus Concert', 'Live music night', 'Music', 'https://example.com/img.jpg', NOW(), 'Main Hall', 100, 50, 'free');
          EOF

      - name: Install dependencies
        working-directory: src/server
        run: npm install

      - name: Run tests
        working-directory: src/server
        run: npm test
